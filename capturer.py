"""
We use this simple script to capture execution data about the samples.

ASSUMPTIONS
1) You have virtualbox installed on your host.
2) You have virtualbox SDK installed on your host.
3) You have a windows VM set up.
4) Your VM has a configured shared folder with guest rights to write in it.
5) You have noriben installed in your VM (hence Python3).
6) You have procmon installed in your VM.
7) All the samples are 7-zipped with password within the same directory (as in the Malware Town repo).
8) All the samples are named with their md5.

It is paramount that you correctly set the following variables (in caps).
"""


import shutil as su
import virtualbox as vb
import os.path as op
import time as tm


# OFFICE
# Path to the list of the samples to capture from
CENSUS_PATH = r"C:\Users\X0275816\Documents\GitHub\malware_town\census.txt"
# Samples dir
SAMPLES_DIR = r"C:\Users\X0275816\Documents\GitHub\malware_town\PEs"
# Windows guest VM name
VM_NAME = "Remzozz"
# VM clean snapshot name
CLEAN_SNAP = "clean"
# Shared folder path on the host
HOST_SHADIR = r"C:\Users\X0275816\Desktop\Virtual_shared\PEs"
# Guest username
GUEST_USER = "REM"
# Guest password
GUEST_PASS = "malware"
# Shared folder path on the guest
GUEST_SHADIR = r"Z:\\"
# Amount of time - in seconds - the capture will take
CAPTURE_SECS = 300


# # TUDELFT
# # Path to the list of the samples to capture from
# CENSUS_PATH = r"D:\npellegrino\My Documents\GitHub\malware_town\census.txt"
# # Samples dir
# SAMPLES_DIR = r"D:\npellegrino\My Documents\GitHub\malware_town\PEs"
# # Windows guest VM name
# VM_NAME = "Remzozz_TUD"
# # VM clean snapshot name
# CLEAN_SNAP = "clean"
# # Shared folder path on the host
# HOST_SHADIR = r"D:\npellegrino\Desktop\VM_shared\PEs"
# # Guest username
# GUEST_USER = "REM"
# # Guest password
# GUEST_PASS = "malware"
# # Shared folder path on the guest
# GUEST_SHADIR = r"Z:\PEs"
# # Amount of time - in seconds - the capture will take
# CAPTURE_SECS = 300



class VBox:

	def __init__(self, vmname, snap):
		vi = vb.VirtualBox()
		self.__machine = vi.find_machine(vmname)
		self.__snapshot = self.__machine.find_snapshot(snap)
		self.__session = None
		
	def connect(self):
		if self.__session is None:
			self.__session = vb.Session()
			self.__machine.create_session(session=self.__session)
			pr = self.__session.machine.restore_snapshot(self.__snapshot)
			pr.wait_for_completion()
			print(self.__session.state)
			# self.__session.unlock_machine()
			# pr = self.__machine.launch_vm_process(self.__session, "gui", "")
			# pr.wait_for_completion()
		
	def disconnect(self):
		if self.__session is not None:
			# self.__session.console.power_down()
			self.__session.unlock_machine()
			self.__session = None


def census():
	with open(CENSUS_PATH, "r") as sh:
		for line in sh:
			yield line.strip().split("\t")[0]


def main():
	# initializing VirtualBox interface
	vbox = VBox(VM_NAME, CLEAN_SNAP)
	# for each sample in the census list
	for hs in census():
		# place it into the host shared folder (copy)
		sn = "{}.7z".format(hs)
		sr = op.join(SAMPLES_DIR, sn)
		ds = op.join(HOST_SHADIR, sn) 
		su.copyfile(sr, ds)
		# connect to the VM
		vbox.connect()
		print("DO SOMETHING")
		# disconnect from the VM
		vbox.disconnect()
		

# def main2():
	# vx = vb.VirtualBox()
	# mc = vx.find_machine(VM_NAME)
	# cs = mc.find_snapshot(CLEAN_SNAP)
	# # for each sample in the census list
	# for hs in census():
		# # place it into the host shared folder (copy)
		# sn = "{}.7z".format(hs)
		# sr = op.join(SAMPLES_DIR, sn)
		# ds = op.join(HOST_SHADIR, sn) 
		# su.copyfile(sr, ds)
		# # create a VirtualBox and a guest session
		# vs = vb.Session()
		# mc.create_session(session=vs)
		# pr = vs.machine.restore_snapshot(cs)
		# while (pr.operation_percent < 100):
			# tm.sleep(.5)
		# # pr = mc.launch_vm_process(vs, "gui", "")
		# # pr.wait_for_completion()
		# # gs = vs.console.guest.create_session(GUEST_USER, GUEST_PASS)
		# # gs.wait_for(1, 0)
		# # restoring the clean snapshot
		# tm.sleep(10)
		# vs.unlock_machine()
		# # closing the session
		# # vs.console.power_down()
		

if __name__ == "__main__":
	main()