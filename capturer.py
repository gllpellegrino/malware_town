"""
We use this simple script to capture execution data about the samples.
It uses 2 VMs, a Linux Remnux to emulate network services and a Windows 10 x64 Remnux Workstation
as a malware execution lab.

ASSUMPTIONS
1) You have virtualbox installed on your host.
2) You have virtualbox SDK installed on your host.
3) You have a windows VM set up.
4) Your VM has a configured shared folder with guest rights to write in it.
5) You have noriben installed in your VM (hence Python3).
6) You have procmon installed in your VM.
7) All the samples are 7-zipped with password within the same directory (as in the Malware Town repo).
8) All the samples are named with their md5.

It is paramount that you correctly set the following variables (in caps).
"""


import os
import configparser as cp
import shutil as su
import virtualbox as vb
import os.path as op
import time as tm


CF = cp.


def configure_remnux():
	vx = vb.VirtualBox()
	
	# Load a clean snapshot
	# Ensure the machine is in internal network
	# Set a static ip
	# Launch the machine
	# Start dns faking
	# Start net services faking
	# Redirect all ip requests to itself
	# Ready!



def census():
	with open(CENSUS_PATH, "r") as sh:
		for line in sh:
			yield line.strip().split("\t")[0]


def main():
	pass


def main_SACRED():
	# initializing VirtualBox interface
	vx = vb.VirtualBox()
	mc = vx.find_machine(WVM_NAME)
	sp = mc.find_snapshot(WVM_CLEAN_SNAP)
	ss = vb.Session()
	# for each sample in the census list
	for hs in census():
		# place it into the host shared folder (copy)
		sn = "{}.7z".format(hs)
		sr = op.join(SAMPLES_DIR, sn)
		# creare gi√† ora directory del sample
		ds = op.join(HOST_SHADIR, sn) 
		su.copyfile(sr, ds)
		# restoring a clean snapshot
		mc.create_session(session=ss)
		pr = ss.machine.restore_snapshot(sp)
		pr.wait_for_completion()
		ss.unlock_machine()
		# connecting to the vm
		pr = mc.launch_vm_process(ss, "gui", "")
		pr.wait_for_completion()
		# move the sample to the vm's desktop
		# unzip the sample
		# execute noriben
		print("I AM DOING")
		# disconnecting from the vm
		pr = ss.console.power_down()
		pr.wait_for_completion()
		

if __name__ == "__main__":
	configure_remnux()