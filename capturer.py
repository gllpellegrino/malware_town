"""
We use this simple script to capture execution data about the samples.
It uses 2 VMs, a Linux Remnux to emulate network services and a Windows 10 x64 Remnux Workstation
as a malware execution lab.

ASSUMPTIONS
1) You have virtualbox installed on your host.
2) You have virtualbox SDK installed on your host.
3) You have a windows VM set up.
4) Your VM has a configured shared folder with guest rights to write in it.
5) You have noriben installed in your VM (hence Python3).
6) You have procmon installed in your VM.
7) All the samples are 7-zipped with password within the same directory (as in the Malware Town repo).
8) All the samples are named with their md5.

It is paramount that you correctly set the following variables (in caps).
"""


import os
import argparse as ap
import configparser as cp
import shutil as su
import virtualbox as vb
import os.path as op
import time as tm


# Configuration File 
CONF = None


def setup():
	global CONF
	# command line parsing
	ps = ap.ArgumentParser()
	ct = op.join(".", "conf", "conf.ini")
	ps.add_argument("--i", default=ct, type=str, help="direct path to the config file ('.ini' format).")	
	ag = ps.parse_args()
	# parsing configuration file
	if not op.exists(ag.i) or not op.isfile(ag.i):
		print("[*] Cannot find the configuration file.")
		sy.exit(2)
	CONF = cp.ConfigParser()
	CONF.read(ag.i)


def configure(vm):
	vx = vb.VirtualBox()
	ss = vb.Session()
	# Load a clean snapshot
	mc = vx.find_machine(vm["name"])
	sp = mc.find_snapshot(vm["clean_snapshot"])
	mc.create_session(session=ss)	
	pr = ss.machine.restore_snapshot(sp)
	pr.wait_for_completion()
	print("[*] \tClean snapshot restored.")
	# Ensure the network setting is in internal network
	ns = int(vm["network_slot"])
	na = ss.machine.get_network_adapter(ns)
	na.attachment_type = vb.library.NetworkAttachmentType(3)
	ss.machine.save_settings()
	ss.unlock_machine()
	print("[*] \tInternal network adapter set up.")


def configure_remnux():
	global CONF
	configure(CONF["VM Linux"])
	# # Set a static ip
	# ur, pw, ic, ip, nm = lm["user"], lm["pass"], lm["interface"], lm["ip"], lm["netmask"]
	# pr = mc.launch_vm_process(ss, "")
	# pr.wait_for_completion()
	# gs = ss.console.guest.create_session(ur, pw)
	# _, ou, er = gs.execute("/usr/bin/sudo", ["/sbin/ifconfig", ic, ip, "netmask", nm])
	# pr = ss.console.power_down()
	# pr.wait_for_completion()
	# print("[*] \tNetwork properties set up.")
		
	
def configure_remzozz():
	global CONF
	vm = CONF["VM Windows"]
	configure(vm)
	# setting a static ip
	ur, pw, ic, ip, nm = vm["user"], vm["pass"], vm["ip"], vm["netmask"], vm["gateway"]
	vx = vb.VirtualBox()
	ss = vb.Session()
	mc = vx.find_machine(vm["name"])
	pr = mc.launch_vm_process(ss, "")
	pr.wait_for_completion()
	gs = ss.console.guest.create_session(ur, pw)
	# _, ou, er = gs.execute("/usr/bin/sudo", ["/sbin/ifconfig", ic, ip, "netmask", nm])


def launch_remnux():
	# Launch the machine
	# Start dns faking
	# Start net services faking
	# Redirect all ip requests to itself
	# Ready!
	pass


def launch_remzozz():
	pass


def census():
	with open(CENSUS_PATH, "r") as sh:
		for line in sh:
			yield line.strip().split("\t")[0]


def main():
	setup()
	print("[*] Configuration file parsed.")
	# configure Remnux
	print("[*] Configuring Remnux VM.")
	configure_remnux()
	print("[*] Remnux VM successfully configured.")
	# configure Remzozz
	configure_remzozz()
	print("[*] Remzozz VM successfully configured.")
	# launch Remnux VM
	launch_remnux()
	print("[*] Remnux launched.")
	# now the fun part starts
	# @todo


def main_SACRED():
	# initializing VirtualBox interface
	vx = vb.VirtualBox()
	mc = vx.find_machine(WVM_NAME)
	sp = mc.find_snapshot(WVM_CLEAN_SNAP)
	ss = vb.Session()
	# for each sample in the census list
	for hs in census():
		# place it into the host shared folder (copy)
		sn = "{}.7z".format(hs)
		sr = op.join(SAMPLES_DIR, sn)
		# creare gi√† ora directory del sample
		ds = op.join(HOST_SHADIR, sn) 
		su.copyfile(sr, ds)
		# restoring a clean snapshot
		mc.create_session(session=ss)
		pr = ss.machine.restore_snapshot(sp)
		pr.wait_for_completion()
		ss.unlock_machine()
		# connecting to the vm
		pr = mc.launch_vm_process(ss, "gui", "")
		pr.wait_for_completion()
		# move the sample to the vm's desktop
		# unzip the sample
		# execute noriben
		print("I AM DOING")
		# disconnecting from the vm
		pr = ss.console.power_down()
		pr.wait_for_completion()
		

if __name__ == "__main__":
	main()